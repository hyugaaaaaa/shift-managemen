# 不具合調査報告書

## 1. 概要
現在のコードベースを調査した結果、システムの動作に重大な影響を与える可能性のある不具合（バグ）と、セキュリティ上のリスクが確認されました。特にセッション管理に関する実装ミスは、ログイン機能や権限チェックが正しく動作しない原因となります。

## 2. 重大な不具合：セッション管理の不備

### 現象
`dashboard.php` や `owner/users.php` などの主要なコントローラーファイルにおいて、`session_start()` が呼び出される前に `$_SESSION` 変数へのアクセスが行われています。

### 詳細
- **原因**: `session_start()` は `template.php` 内で呼び出されていますが、各コントローラーでは `template.php` を読み込む**前**にログインチェック（`$_SESSION['user_id']` の確認）を行っています。
- **影響**: `session_start()` が実行されていない状態で `$_SESSION` を参照するため、値が取得できず、ログインしていても「未ログイン」と判定され、ログイン画面にリダイレクトされる（または無限ループになる）可能性があります。
- **該当ファイル**:
  - `dashboard.php`
  - `parttime/submit_shift.php`
  - `owner/users.php`
  - `owner/monthly_hours.php`
  - その他、`template.php` を読み込む前にセッションチェックを行っている全ファイル

### 修正案
各ファイルの先頭（`require_once .../config.php` の直後など）で明示的に `session_start()` を呼び出すか、セッションチェックのロジックを `template.php` 読み込み後に移動する必要があります。ただし、`header()` によるリダイレクトを行う場合は、HTML出力（`template.php` 内の `render_header` など）の前に行う必要があるため、**ファイルの先頭で `session_start()` を呼ぶのが最も安全かつ確実です。**

## 3. セキュリティリスク

### DB接続情報のハードコード
`config.php` にデータベースの接続情報（ホスト名、ユーザー名、パスワード）が直接記述されています。
- **リスク**: ソースコードが漏洩した場合、データベースへの不正アクセスにつながる恐れがあります。
- **推奨**: 環境変数（`.env` ファイルなど）を利用して管理することを推奨します。

## 4. その他の確認事項

### XSS（クロスサイトスクリプティング）対策
`views/dashboard_view.php` などを確認した限り、`htmlspecialchars()` を使用して出力のエスケープ処理が行われており、基本的な対策は実施されています。

### CSRF対策
`functions.php` にトークン生成・検証ロジックがあり、`submit_shift.php` などの更新処理で利用されているため、対策は行われています。

### ロジックの複雑性
`dashboard.php` 内に、日をまたぐシフト（例: 22:00〜26:00）を表示用に分割するロジックが記述されています。現状は動作すると思われますが、ロジックがビューに近い場所にあり複雑なため、将来的な保守性を考慮すると `functions.php` やクラスメソッドへの切り出しを検討しても良いでしょう。

## 5. 結論
**セッション管理の不備は、システムが正常に利用できないクリティカルな問題です。** 早急な修正が必要です。
