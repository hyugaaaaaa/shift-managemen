# システム詳細再調査報告書

## 1. 概要
前回のセッション管理修正に続き、システム全体のセキュリティと堅牢性を再調査しました。その結果、以下の改善すべき点が見つかりました。

## 2. 発見された問題点

### 2.1 権限チェックの不備 (IDORのリスク)
- **対象ファイル**: `parttime/payslip_view.php`
- **現状**: パートタイムユーザーの場合、`$target_user_id` は自身のID (`$_SESSION['user_id']`) に固定されていますが、URLパラメータ `user_id` を改ざんしてアクセスした場合の挙動が、コード上は `if ($user_type === 'owner' && !empty($_GET['user_id']))` で制御されているため、一見安全に見えます。
- **リスク**: しかし、将来的な改修で条件分岐が複雑になった際、意図せず他人の給与明細が見えてしまうリスクがあります。より堅牢にするため、パートタイムユーザーの場合は強制的に `$_GET['user_id']` を無視する、あるいは自分のIDと異なるIDが指定された場合はエラーにする等の明示的なガードが望ましいです。
- **現状の評価**: 現時点のコードでは**脆弱性はありません**が、防御的プログラミングの観点から改善の余地があります。

### 2.2 入力バリデーションの不足
- **対象ファイル**: `parttime/submit_shift.php`, `owner/user_edit.php`
- **現状**: 必須チェック (`empty()`) は行われていますが、データ形式のチェックが不十分です。
    - `shift_date`: 日付フォーマット (`Y-m-d`) かどうかのチェックがありません。不正な文字列がDBに送られる可能性があります（DB側でエラーになるか、0000-00-00等になる）。
    - `start_time`, `end_time`: 時間フォーマット (`H:i`) のチェックがありません。
    - `hourly_rate`: 数値であるかのチェックはありますが、負の値や異常に大きな値のチェックがありません。
- **リスク**: データの整合性が損なわれる可能性があります。

### 2.3 DB接続情報のハードコード
- **対象ファイル**: `config.php`
- **現状**: DBのパスワード等がソースコードに直書きされています。
- **リスク**: ソースコード流出時に即座にDBへのアクセスを許してしまいます。

## 3. 推奨される修正方針

1.  **入力バリデーションの強化**:
    -   日付・時刻形式の正規表現チェックを追加。
    -   数値の範囲チェックを追加。
2.  **環境変数の導入**:
    -   `config.php` を修正し、`.env` ファイル等から設定を読み込むように変更（または、サーバーの環境変数を参照）。

## 4. 結論
致命的な脆弱性は現時点で見当たりませんが、システムの安定稼働とセキュリティ向上のため、入力バリデーションの強化を推奨します。
