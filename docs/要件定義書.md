# 要件定義書

## 1. 機能要件

### 1.1 共通機能
*   **ログイン/ログアウト**: ユーザーIDとパスワードによる認証。
*   **初期アカウント登録**: システムにユーザーが一人も登録されていない場合のみ、ログイン画面から初期アカウント（オーナー）を登録可能。
*   **ダッシュボード**: ログインユーザーに応じた情報の表示（カレンダー形式のシフト表など）。
*   **ヘルプ**: システムの利用方法を表示するヘルプページ。
*   **パスワード変更**: ユーザー自身によるパスワード変更機能。
*   **LINE通知連携**: LINE Notifyを利用したお知らせ通知機能。
*   **お知らせ表示**: オーナーからの連絡事項をダッシュボードに表示。

### 1.2 オーナー（管理者）機能
#### 1.2.1 従業員管理
*   **従業員一覧表示**: 登録されている従業員のID、名前、時給、交通費を表示（論理削除されたユーザーは非表示）。
*   **従業員登録・編集・削除**:
    *   基本情報（ユーザー名、メールアドレス、パスワード）の登録・変更。
    *   雇用条件（基本時給、1日あたりの交通費）の設定。
    *   **スキル管理**: 従業員ごとの保有スキル（例: キッチン、ホール、レジ締め等）の登録・紐付け。
    *   **削除確認**: 誤操作防止のため、Bootstrap Modalによる確認ダイアログを表示。
    *   パスワードリセット機能。

#### 1.2.2 シフト管理
*   **希望シフト一覧**: 従業員から提出されたシフト希望の確認。
*   **シフト作成・編集**: 日付・時間指定によるシフトの登録・修正・削除。
    *   承認時に定休日チェックを実施し、誤承認を防止。
    *   **承認・却下確認**: Bootstrap Modalによる確認ダイアログを表示し、操作内容を明確化。
*   **シフト交換管理**: 従業員からのシフト交換申請の確認・承認・却下。
*   **月間シフト表示**: カレンダー形式での全従業員のシフト確認。
*   **定休日設定**: 月ごとの定休日設定。設定日はシフト提出不可とする。

#### 1.2.3 給与管理
*   **月間給与集計**:
    *   指定月（締め日に基づく期間）の全従業員の勤務時間・給与を集計表示。
    *   **深夜割増計算**: 22:00〜翌05:00 の勤務時間を自動判定し、時給を1.25倍で計算。
    *   **交通費計算**: 出勤日数 × 設定された交通費を加算。
    *   **締め日処理**: 設定された締め日（例: 15日）に基づいて集計期間を自動算出（例: 前月16日〜当月15日）。
*   **明細確認**: 各従業員の給与明細プレビュー機能。

#### 1.2.4 システム管理
*   **システム設定**:
    *   シフト提出締め切り日
    *   給与締め日
    *   給与支払日
*   **お知らせ管理**: 従業員向けのお知らせ作成・削除機能。作成時にLINE通知を一斉送信。
*   **データ出力**: 給与明細およびシフト表のCSV出力機能。ファイルはサーバー上の指定ディレクトリ（C:\shift_management）に保存。

### 1.3 パートタイム（従業員）機能
#### 1.3.1 シフト関連
*   **シフト希望提出**: 日付、開始時間、終了時間を指定して希望を送信。
    *   締め切り日による提出制限。
    *   定休日および重複シフトの提出制限。
*   **確定シフト確認**: 自分のシフトスケジュールを一覧・カレンダーで確認。
*   **シフト交換申請**: 確定したシフトに対して、他の従業員への交換申請や、交換募集を行う機能。

#### 1.3.2 給与明細
*   **電子交付同意**: 給与明細の電子交付に対する同意/不同意の登録（初回必須）。
*   **明細一覧**: 過去の給与明細（月別）の一覧表示。
*   **明細閲覧・印刷**:
    *   詳細な給与明細書（支給項目、勤怠項目）のWeb表示。
    *   A4サイズでの印刷に最適化されたレイアウト。

#### 1.3.3 その他
*   **パスワードリセット**: 登録メールアドレスを使用したパスワード再設定機能。

## 2. 非機能要件

### 2.1 ユーザビリティ（UI/UX）
*   **デザイン**: インディゴブルーを基調とし、グラデーションやフェードインアニメーションを取り入れたモダンなデザイン。
    *   カレンダー表示はセルサイズを統一し、視認性と操作性を確保。
*   **フォント**: 視認性の高い Google Fonts (Inter, Noto Sans JP) を使用。
*   **レスポンシブ**: PC、タブレット、スマートフォンでの閲覧・操作に対応。
*   **モーダルダイアログ**: 削除や承認などの重要操作時にはモーダルダイアログを表示し、ユーザーへのフィードバックと誤操作防止を徹底。

### 2.2 セキュリティ
*   **認証**: パスワードはハッシュ化（`password_hash`）してデータベースに保存。
*   **セッション管理**: 30分間の無操作で自動ログアウト（セッションタイムアウト）。
*   **アカウントロック**: 連続5回のログイン失敗でアカウントを30分間ロック。
*   **アクセス制御**:
    *   ユーザー種別（owner/part-time）による厳格なページアクセス制限。
    *   論理削除されたユーザーに対する編集画面等へのアクセスをブロック。
*   **入力対策**:
    *   ヘルパー関数 `h()` を使用した徹底的なXSS対策。
    *   全フォームへのCSRFトークン導入と検証による不正リクエスト防止。
    *   プリペアドステートメントによるSQLインジェクション対策。

### 2.3 データ要件
*   **データベース**: MySQL (MariaDB) を使用。
*   **データ構造**:
    *   ユーザー情報、シフト情報、給与明細情報に加え、以下のデータを管理。
    *   `is_deleted`: ユーザーの論理削除フラグ（削除されたユーザーはシステム上から非表示）。
    *   `holidays`: 定休日管理テーブル。
    *   `skills`: 従業員のスキルマスタ。
    *   `shift_exchanges`: シフト交換申請データ。
    *   `operation_logs`: 重要な操作のログデータ。
    *   `password_resets`: パスワードリセット用トークン管理。
*   **設定管理**: 締め日、支払日などのシステム設定はデータベース（`system_settings` テーブル）で管理。

## 3. システム環境
*   **サーバーサイド**: PHP 7.4以上
*   **データベース**: MySQL / MariaDB
*   **クライアント**: モダンブラウザ（Chrome, Edge, Safari, Firefox）
