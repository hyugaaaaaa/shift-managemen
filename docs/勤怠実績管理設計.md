# 勤怠実績管理機能 設計書

## 1. 概要
シフト予定と実際の勤務内容（実績）に差異が生じた場合（病欠、残業、遅刻、早退など）に対応するため、**勤怠実績（Attendance）** を管理する機能を導入する。

## 2. 現状の課題
*   現在は「シフト予定（`shifts_scheduled`）」がそのまま勤務時間として扱われている（と推測される）。
*   急な病欠や、繁忙による残業などが発生した場合、システム上の記録と実態が乖離し、給与計算が正しく行えない。

## 3. 解決策の提案
「予定」とは別に「実績」を保存するテーブルを作成し、給与計算の基礎データを「実績」とする。

### 3.1 データモデル (DBスキーマ変更案)

新たに `attendance_records` テーブルを作成する。

```sql
CREATE TABLE attendance_records (
    attendance_id INT UNSIGNED NOT NULL AUTO_INCREMENT,
    user_id INT UNSIGNED NOT NULL,
    schedule_id INT UNSIGNED DEFAULT NULL, -- 対応するシフト予定ID（予定外勤務の場合はNULLも可）
    date DATE NOT NULL,                    -- 勤務日
    clock_in_time DATETIME,                -- 実績出勤時間
    clock_out_time DATETIME,               -- 実績退勤時間
    status ENUM('present', 'absent', 'late', 'early_leave', 'paid_leave') NOT NULL DEFAULT 'present',
    notes TEXT,                            -- 備考（欠勤理由、残業理由など）
    is_approved BOOLEAN DEFAULT FALSE,     -- オーナー承認済みか
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (attendance_id),
    FOREIGN KEY (user_id) REFERENCES users(user_id),
    FOREIGN KEY (schedule_id) REFERENCES shifts_scheduled(schedule_id)
);
```

### 3.2 運用フロー案

#### ケースA：病欠で急に出勤できなくなった場合
1.  **連絡**: 従業員は電話等でオーナーに連絡（現状通り）。
2.  **システム登録**:
    *   **パターン1（オーナー代行）**: オーナーが管理画面から該当日の実績データを呼び出し、ステータスを「欠勤 (`absent`)」に変更。備考に「体調不良により欠勤」と記載。
    *   **パターン2（従業員申請）**: 従業員がスマホから「欠勤申請」を行い、オーナーが承認。

#### ケースB：勤務時間が予定より長くなった（残業）
1.  **勤務**: 従業員は予定時間を超えて勤務。
2.  **実績記録**:
    *   **打刻なしの場合**: 翌日以降、従業員が「実績修正画面」にて、退勤時間を修正（例: 17:00 → 18:00）し、備考に「繁忙のため残業」と記載して保存。
    *   **打刻ありの場合**: 退勤時に「退勤ボタン」を押すことで、現在時刻が `clock_out_time` として記録される。
3.  **承認**: オーナーは実績と予定の差異を確認し、問題なければ「承認」する。

### 3.3 画面・機能要件

#### アルバイト側
*   **勤怠実績確認・修正画面**:
    *   自分のシフト予定と実績を一覧表示。
    *   実績時間（出勤・退勤）の修正入力フォーム。
    *   備考欄（修正理由の入力）。
    *   保存ボタン（申請状態になる）。

#### オーナー側
*   **勤怠承認画面**:
    *   従業員ごとの日次実績一覧。
    *   予定と実績に差異があるレコードをハイライト表示。
    *   承認ボタン（承認することで給与計算対象となる）。
    *   直接編集機能（オーナー権限での強制修正）。

## 4. 給与計算ロジックの変更
`functions.php` 内の給与計算ロジックを以下のように変更する。

*   **変更前**: `shifts_scheduled` テーブルの `start_time`, `end_time` を使用。
*   **変更後**: `attendance_records` テーブルを参照。
    *   レコードが存在し、かつ `status` が `present` (または `late`, `early_leave`) の場合、`clock_in_time` と `clock_out_time` を使用して計算。
    *   `status` が `absent` の場合は給与発生なし。
    *   レコードが存在しない（未打刻・未登録）場合は、暫定的に `shifts_scheduled` を使うか、あるいは「未確定」として警告を出す（運用ルールによる）。

## 5. 今後のステップ
1.  本設計案の承認
2.  DBマイグレーションの実施
3.  オーナー用・従業員用の画面実装
4.  給与計算ロジックの改修
