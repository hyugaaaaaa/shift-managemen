# システム概要書

## 1. システム名称
アルバイトシフト管理・給与計算システム

## 2. システムの目的
本システムは、飲食店や小売店などの店舗運営において、アルバイト従業員のシフト管理業務および給与計算業務を効率化・自動化することを目的とします。
従来、紙やエクセルで行われていた複雑なシフト調整や、深夜割増を含む給与計算をシステム化することで、管理者の負担を軽減し、計算ミスを防ぎます。また、給与明細の電子交付により、ペーパーレス化を推進します。

## 3. 利用者と役割
| 利用者 | 役割 | 主な利用シーン |
| :--- | :--- | :--- |
| **オーナー (管理者)** | 店舗の責任者 | 従業員管理、シフト確定、給与計算確認、システム設定 |
| **パートタイム (従業員)** | アルバイトスタッフ | シフト希望提出、確定シフト確認、給与明細閲覧 |

## 4. システム全体像
本システムはWebアプリケーションとして提供され、PCおよびスマートフォンからブラウザを通じて利用します。

### 主な業務フロー
1.  **従業員登録**: オーナーが従業員情報を登録（時給・交通費設定）。
2.  **シフト希望提出**: 従業員がスマホ等から希望シフトを提出。
3.  **シフト作成・確定**: オーナーが希望を確認し、シフトを作成・確定。
4.  **勤務・集計**: （※本システムでは打刻機能は含まず、シフト予定時間を勤務時間として扱う運用を想定、または実績修正運用）
5.  **給与計算**: 締め日に基づき、深夜割増・交通費を含めた給与を自動計算。
6.  **明細交付**: 従業員がWeb上で給与明細を確認・印刷。

## 5. 特徴的な機能
*   **高度な給与計算**: 深夜時間帯（22:00〜05:00）の自動割増計算（25%UP）に対応。
*   **電子明細**: 法的要件（同意取得）を満たした上での給与明細電子交付機能。
*   **スキル管理**: 従業員のスキル（資格や業務可能範囲）を登録・管理し、最適な人員配置を支援。
*   **お知らせ・掲示板**: オーナーから従業員への一斉連絡機能。ダッシュボードで確認可能。
*   **LINE通知連携**: 重要なお知らせをLINEで受け取れる通知機能（LINE Notify利用）。
*   **定休日管理**: 月ごとの定休日設定機能。設定された日はシフト提出が自動的に制限されます。
*   **柔軟なシステム設定**: シフト提出締め切り日、給与締め日、給与支払日をオーナーが自由に設定可能。
*   **データ出力**: 給与明細やシフト表をCSV形式で出力し、サーバー（C:\shift_management）に保存可能。
*   **論理削除**: 誤操作によるデータ消失を防ぐため、ユーザー削除は論理削除（無効化）として実装。
*   **セキュリティ強化**:
    *   全フォームへのCSRFトークン導入による不正リクエスト防止。
    *   論理削除されたユーザーへのアクセスブロック機能。
    *   アカウントロック、セッションタイムアウト、パスワード変更機能。
*   **モダンなUI**:
    *   インディゴブルーを基調とした洗練されたデザイン。
    *   カレンダーのマス目を均等配置し、視認性と操作性を向上。
    *   フェードインアニメーションによる滑らかな画面遷移。

## 6. 技術的構成・アーキテクチャ
保守性、拡張性、安全性を高めるため、以下の技術的アプローチを採用しています。

### 6.1 ロジックと表示の分離 (MVC構成)
プログラムの「処理ロジック（Controller）」と「画面表示（View）」を明確に分離しています。
*   **Controller**: データの取得、計算、保存処理を担当（例: `dashboard.php`）。
*   **View**: HTMLの生成と表示を担当（例: `views/dashboard_view.php`）。
これにより、デザインの変更がロジックに影響を与えず、安全かつ効率的に開発・保守が可能です。

### 6.2 共通ロジックの集約
給与計算やシステム設定の取得など、システム全体で利用される重要なロジックは `functions.php` に集約しています。
*   **一元管理**: 計算式やルールの変更が一箇所で完結し、修正漏れや計算ミスを防ぎます。

### 6.3 セキュリティ対策
*   **CSRF対策**: ログイン、登録、更新などの重要な処理において、CSRFトークンによる検証を導入し、不正なリクエストを防止しています。
*   **SQLインジェクション対策**: データベース操作にはPDOのプリペアドステートメントを使用し、安全性を確保しています。

## 7. ファイル構成

### 7.1 共通・基盤
*   `index.php`: ログイン画面（Controller）。初期登録機能も含む。
*   `register.php`: 初期アカウント登録画面（Controller）。
*   `dashboard.php`: ダッシュボード（Controller）。ログイン後のトップページで、シフトカレンダーを表示。
*   `config.php`: データベース接続設定および共通設定。
*   `functions.php`: 共通関数群（給与計算、設定取得、CSRF対策など）。
*   `template.php`: ヘッダー・フッターなどの共通HTMLパーツ。
*   `logout.php`: ログアウト処理。
*   `help.php`: ヘルプ画面（Controller）。
*   `change_password.php`: パスワード変更画面（Controller）。
*   `css/style.css`: サイト全体のデザイン定義。

### 7.2 オーナー機能 (`owner/`)
*   `users.php`: 従業員一覧画面（Controller）。
*   `user_edit.php`: 従業員登録・編集画面（Controller）。
*   `monthly_hours.php`: 月間労働時間・給与集計画面（Controller）。
*   `manage_requests.php`: シフト希望一覧・確定画面（※リファクタリング対象外）。
*   `system_settings.php`: システム設定画面（Controller）。
*   `export_data.php`: データ出力画面（Controller）。

### 7.3 アルバイト機能 (`parttime/`)
*   `submit_shift.php`: シフト希望提出画面（Controller）。
*   `view_schedule.php`: 確定シフト確認画面（Controller）。
*   `payslip_list.php`: 給与明細一覧・同意画面（Controller）。
*   `payslip_view.php`: 給与明細詳細・印刷画面（Controller）。

### 7.4 表示テンプレート (`views/`)
各機能のHTML表示部分を格納しています。
*   `login_view.php`: ログイン画面用。
*   `register_view.php`: 初期アカウント登録画面用。
*   `dashboard_view.php`: ダッシュボード用。
*   `help_view.php`: ヘルプ画面用。
*   `change_password_view.php`: パスワード変更画面用。
*   `owner/`: オーナー機能用テンプレート（`users_view.php`, `user_edit_view.php`, `monthly_hours_view.php`, `system_settings_view.php`, `export_data_view.php`）。
*   `parttime/`: アルバイト機能用テンプレート（`submit_shift_view.php`, `view_schedule_view.php`, `payslip_list_view.php`, `payslip_view_view.php`）。
